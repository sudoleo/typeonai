<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consens AI</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
  <!-- Füge dies im <head> hinzu -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Optional für Sicherheit: -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
  <!-- Firebase-Konfiguration aus Umgebungsvariablen -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
  <script>
    window.FIREBASE_CONFIG = {
      apiKey: "{{ firebase_api_key }}",
      authDomain: "{{ firebase_auth_domain }}",
      projectId: "{{ firebase_project_id }}",
      storageBucket: "{{ firebase_storage_bucket }}",
      messagingSenderId: "{{ firebase_messaging_sender_id }}",
      appId: "{{ firebase_app_id }}"
    };
  </script>
</head>
<body>
  <header class="top-bar">
    <!-- Sidebar Toggle Button -->
    <button id="toggleSidebarButton" class="sidebar-toggle collapse-btn">
      <span class="burger-icon">&#9776;</span>
    </button>
    <!-- Logo und Titel -->
    <div class="top-bar-logo">
      <span class="top-bar-title">Consens AI</span>
    </div>
    <!-- Container für rechte Elemente -->
    <div class="top-bar-right">
      <div id="loginContainer" class="login-text">Einloggen und gratis nutzen</div>
      <div class="mode-switch">
        <label class="switch">
          <input type="checkbox" id="modeToggle">
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </header>
   
  <br/><br/><br/>
<!-- Toggle-Button für die Sidebar (wird im responsiven Modus eingeblendet) -->
<div class="sidebar-toggle">
  <button id="toggleSidebarButton" class="collapse-btn">
    <span class="arrow">&#9776;</span>
  </button>
</div>
<!-- Sidebar für API Keys -->
<div class="sidebar">
  <div class="sidebar-content">
    <div class="sidebar-header">
      <h2>API Keys</h2>
      <button id="toggleApiTest" onclick="toggleApiTest()" class="collapse-btn">
        <span class="arrow">&#9660;</span>
      </button>
    </div>
    <div id="apiTestArea" class="api-test-area">
      <div class="api-key-group">
        <label for="openaiKey">OpenAI API Key <span id="openaiFeedback" class="feedback"></span></label>
        <input type="password" id="openaiKey" placeholder="Dein OpenAI Key">
      </div>
      <div class="api-key-group">
        <label for="mistralKey">Mistral API Key <span id="mistralFeedback" class="feedback"></span></label>
        <input type="password" id="mistralKey" placeholder="Dein Mistral Key">
      </div>
      <div class="api-key-group">
        <label for="anthropicKey">Anthropic API Key <span id="anthropicFeedback" class="feedback"></span></label>
        <input type="password" id="anthropicKey" placeholder="Dein Anthropic Key">
      </div>
      <div class="api-key-group">
        <label for="geminiKey">Google API Key <span id="geminiFeedback" class="feedback"></span></label>
        <input type="password" id="geminiKey" placeholder="Dein Gemini Key">
      </div>
      <div class="api-key-group">
        <label for="deepseekKey">DeepSeek API Key <span id="deepseekFeedback" class="feedback"></span></label>
        <input type="password" id="deepseekKey" placeholder="Dein DeepSeek Key">
      </div>
      <button onclick="testAllKeys()">
        Alle APIs testen 
        <span id="apiSpinner" class="spinner" style="display: none;"></span>
      </button>
    </div>
    <div id="usageOptions">
      <label>
        <input type="checkbox" id="useOwnKeysSwitch">
        Eigene API Keys verwenden
      </label>
      <span id="freeUsageDisplay"></span>
    </div>   

    <!-- Trennstrich zwischen API Keys und Modelle -->
    <div class="sidebar-separator"></div>

    <!-- Verwendete Modelle (einklappbar) -->
    <div class="sidebar-header model-header">
      <h2>Verwendete Modelle</h2>
      <button id="toggleModelSelection" onclick="toggleModelSelection()" class="collapse-btn">
        <span class="arrow">&#9660;</span>
      </button>
    </div>
    <div id="modelSelectionArea" class="model-selection">
      <label for="selectOpenAI">
        <input type="checkbox" id="selectOpenAI" checked> OpenAI
      </label>
      <label for="selectMistral">
        <input type="checkbox" id="selectMistral" checked> Mistral
      </label>
      <label for="selectClaude">
        <input type="checkbox" id="selectClaude" checked> Anthropic Claude
      </label>
      <label for="selectGemini">
        <input type="checkbox" id="selectGemini" checked> Google Gemini
      </label>
      <label for="selectDeepSeek">
        <input type="checkbox" id="selectDeepSeek" checked> DeepSeek
      </label>
    </div>

    <!-- Trennstrich zwischen API Keys und Leaderboard -->
    <div class="sidebar-separator"></div>

    <!-- Leaderboard -->
    <div class="sidebar-header">
      <h2>Leaderboard</h2>
      <button id="toggleLeaderboard" class="collapse-btn" onclick="toggleLeaderboard()">
        <span class="arrow">&#9660;</span>
      </button>
    </div>
    <div id="leaderboardContentContainer" class="hidden">
      <div id="leaderboardContent"></div>
    </div>
  </div>
</div>

  <!-- Mode-Switch in der oberen rechten Ecke -->
  <div class="mode-switch">
    <label class="switch">
      <input type="checkbox" id="modeToggle">
      <span class="slider"></span>
    </label>
  </div>

  <div class="container">
    <div class="input-section">
      <div class="chat-input-container">
        <textarea class="input-field" id="questionInput" placeholder="Geben Sie Ihre Frage ein"></textarea>
        <button class="button" id="sendButton" onclick="sendQuestion()">
          <!-- SVG-Icon für einen Pfeil, der nach unten zeigt -->
          <svg class="input-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>
    </div>
    
    <div class="response-section">
      <!-- Antwort OpenAI -->
      <div class="response-box" id="openaiResponse" data-model="OpenAI">
        <h2>
          <span class="title">Antwort von ChatGPT <small>(GPT-4o)</small></span>
          <div class="control-icons">
            <span class="best-btn" onclick="toggleBest('openaiResponse')" title="Als beste Antwort markieren">&#10003;</span>
            <span class="exclude-btn" onclick="toggleExclude('openaiResponse')" title="Antwort ausschließen">&#10005;</span>
            <button class="collapse-btn" onclick="toggleCollapse('openaiResponse')">
              <span class="arrow">&#9660;</span>
            </button>
          </div>
        </h2>
        <p class="collapsible-content"></p>
      </div>
      <!-- Antwort Mistral -->
      <div class="response-box" id="mistalResponse" data-model="Mistral">
        <h2>
          <span class="title">Antwort von Mistral <small>(mistral-large-latest)</small></span>
          <div class="control-icons">
            <span class="best-btn" onclick="toggleBest('mistalResponse')" title="Als beste Antwort markieren">&#10003;</span>
            <span class="exclude-btn" onclick="toggleExclude('mistalResponse')" title="Antwort ausschließen">&#10005;</span>
            <button class="collapse-btn" onclick="toggleCollapse('mistalResponse')">
              <span class="arrow">&#9660;</span>
            </button>
          </div>
        </h2>
        <p class="collapsible-content"></p>
      </div>
      <!-- Antwort Anthropic Claude -->
      <div class="response-box" id="claudeResponse" data-model="Anthropic">
        <h2>
          <span class="title">Antwort von Claude <small>(claude-3-5-sonnet)</small></span>
          <div class="control-icons">
            <span class="best-btn" onclick="toggleBest('claudeResponse')" title="Als beste Antwort markieren">&#10003;</span>
            <span class="exclude-btn" onclick="toggleExclude('claudeResponse')" title="Antwort ausschließen">&#10005;</span>
            <button class="collapse-btn" onclick="toggleCollapse('claudeResponse')">
              <span class="arrow">&#9660;</span>
            </button>
          </div>
        </h2>
        <p class="collapsible-content"></p>
      </div>
      <!-- Antwort Google Gemini -->
      <div class="response-box" id="geminiResponse" data-model="Gemini">
        <h2>
          <span class="title">Antwort von Gemini <small>(gemini-pro)</small></span>
          <div class="control-icons">
            <span class="best-btn" onclick="toggleBest('geminiResponse')" title="Als beste Antwort markieren">&#10003;</span>
            <span class="exclude-btn" onclick="toggleExclude('geminiResponse')" title="Antwort ausschließen">&#10005;</span>
            <button class="collapse-btn" onclick="toggleCollapse('geminiResponse')">
              <span class="arrow">&#9660;</span>
            </button>
          </div>
        </h2>
        <p class="collapsible-content"></p>
      </div>
      <!-- Antwort DeepSeek -->
      <div class="response-box" id="deepseekResponse" data-model="DeepSeek">
        <h2>
          <span class="title">Antwort von DeepSeek <small>(deepseek-chat)</small></span>
          <div class="control-icons">
            <span class="best-btn" onclick="toggleBest('deepseekResponse')" title="Als beste Antwort markieren">&#10003;</span>
            <span class="exclude-btn" onclick="toggleExclude('deepseekResponse')" title="Antwort ausschließen">&#10005;</span>
            <button class="collapse-btn" onclick="toggleCollapse('deepseekResponse')">
              <span class="arrow">&#9660;</span>
            </button>
          </div>
        </h2>
        <p class="collapsible-content"></p>
      </div>      
    </div>
    
    <!-- Konsens-Section -->
    <div class="consensus-section">
      <div class="consensus-wrapper">
        <!-- Konsens-Kontrolle: Schalter, Button und Dropdown wie gehabt -->
        <div class="consensus-controls">
          <button id="consensusButton" onclick="getConsensus()">Konsens‑Antwort generieren</button>
          <div class="auto-consensus">
            <label class="switch">
              <input type="checkbox" id="autoConsensusToggle">
              <span class="slider"></span>
            </label>
            <span class="auto-consensus-label">Auto Konsens</span>
          </div>
          <div class="consensus-model">
            <label for="consensusModelDropdown" class="consensus-label">Konsens‑Modell:</label>
            <div class="select-wrapper">
              <select id="consensusModelDropdown">
                <option value="Anthropic Claude">claude-3-5</option>
                <option value="Mistral">mistral-large-latest</option>
                <option value="OpenAI">GPT‑4o</option>
                <option value="Google Gemini">gemini-pro</option>
                <option value="DeepSeek">deepseek-chat</option>
              </select>
            </div>
          </div>
        </div>
        <!-- Konsens-Box mit zwei nebeneinanderliegenden Bereichen -->
        <div class="consensus-box" id="consensusResponse">
          <!-- Linker Bereich: Konsens-Antwort (80%) -->
          <div class="consensus-main">
            <h2>Konsens‑Antwort</h2>
            <p></p>
          </div>
          <!-- Rechter Bereich: Unterschiede (20%) -->
          <div class="consensus-differences">
            <h2>Unterschiede</h2>
            <p></p>
          </div>
        </div>
      </div>
    </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // --------------------------
      // Dark/Light Mode Initialisierung
      // --------------------------
      const modeToggle = document.getElementById("modeToggle");
      const darkModeStored = localStorage.getItem("darkMode");
      if (darkModeStored === "true") {
        document.body.classList.add("dark-mode");
        modeToggle.checked = true;
      } else {
        document.body.classList.remove("dark-mode");
        modeToggle.checked = false;
      }
      modeToggle.addEventListener("change", function() {
        const isDark = this.checked;
        document.body.classList.toggle("dark-mode", isDark);
        localStorage.setItem("darkMode", isDark ? "true" : "false");
      });

      // --------------------------
      // API Keys Initialisierung
      // --------------------------
      const FREE_USAGE_LIMIT = 25;
      const apiKeys = ["openaiKey", "mistralKey", "anthropicKey", "geminiKey", "deepseekKey"];
      apiKeys.forEach(function(key) {
        const stored = localStorage.getItem(key);
        if (stored) {
          const inputEl = document.getElementById(key);
          if (inputEl) {
            inputEl.value = stored;
          }
        }
      });
    
      // --------------------------
      // Event-Listener für Eingabefelder und Buttons
      // --------------------------
    
      // Frage per Enter (ohne Zeilenumbruch) absenden
      document.getElementById("questionInput").addEventListener("keydown", function(event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendQuestion();
        }
      });
    
      document.getElementById("toggleSidebarButton").addEventListener("click", function() {
        const sidebar = document.querySelector(".sidebar");
        sidebar.classList.toggle("collapsed");
      });

      document.getElementById('toggleSidebarButton').addEventListener('click', function() {
        const sidebar = document.querySelector('.sidebar');
        sidebar.classList.toggle('active');
      });
    
      // Fenstergröße prüfen – wenn <1024px, Sidebar einklappen
      function checkWindowSize() {
        const sidebar = document.querySelector(".sidebar");
        if (window.innerWidth < 1024) {
          sidebar.classList.add("collapsed");
        } else {
          sidebar.classList.remove("collapsed");
        }
        updateToggleButton();
      }
      window.addEventListener("resize", checkWindowSize);
      checkWindowSize(); // Initial
    
      // Aktualisiert den Pfeil des Sidebar-Toggle-Buttons
      function updateToggleButton() {
        const sidebar = document.querySelector(".sidebar");
        const newText = sidebar.classList.contains("collapsed") ? "►" : "◄";
        const arrow = document.querySelector(".sidebar-toggle .arrow");
        if (arrow) {
          arrow.textContent = newText;
        }
      }

      // Extrahiert aus dem Differences-Text den BestModel-Wert
      function parseBestModel(differencesText) {
        const regex = /BestModel:\s*(.*)/i;
        const match = differencesText.match(regex);
        return match ? match[1].trim() : null;
      }
    
      // --------------------------
      // Globale Funktionen (für Inline-Aufrufe)
      // --------------------------

      window.toggleBest = function(responseId) {
        const box = document.getElementById(responseId);
        if (box.classList.contains("excluded")) return;
        if (box.classList.contains("best")) {
          box.classList.remove("best");
        } else {
          document.querySelectorAll(".response-box").forEach(b => b.classList.remove("best"));
          box.classList.add("best");
          const model = box.getAttribute("data-model");
          // Direkter Aufruf zur Firebase-Funktion:
          recordModelVote(model, "best");
        }
      };

      // API Testbereich umschalten (für den Pfeil in der API Keys Section)
      window.toggleApiTest = function() {
        const area = document.getElementById("apiTestArea");
        const button = document.getElementById("toggleApiTest");
        const arrow = button.querySelector(".arrow");
        if (area.style.display === "none" || area.style.display === "") {
          area.style.display = "block";
          arrow.classList.add("rotated");
        } else {
          area.style.display = "none";
          arrow.classList.remove("rotated");
        }
      };
    
      // Modelle-Auswahl umschalten (für den Pfeil in der Modelle Section)
      window.toggleModelSelection = function() {
        const area = document.getElementById("modelSelectionArea");
        const button = document.getElementById("toggleModelSelection");
        const arrow = button.querySelector(".arrow");
        if (area.style.display === "none" || area.style.display === "") {
          area.style.display = "block";
          arrow.classList.add("rotated");
        } else {
          area.style.display = "none";
          arrow.classList.remove("rotated");
        }
      };
    
      // Collapse/Expand einer Antwort-Box
      window.toggleCollapse = function(responseId) {
        const responseBox = document.getElementById(responseId);
        const content = responseBox.querySelector(".collapsible-content");
        const arrow = responseBox.querySelector(".collapse-btn .arrow");
        content.classList.toggle("collapsed");
        arrow.classList.toggle("rotated");
      };
    
      // Exclude/Include einer Antwort-Box (falls nicht als "best" markiert)
      window.toggleExclude = function(responseId) {
        const box = document.getElementById(responseId);
        if (box.classList.contains("best")) return;
        box.classList.toggle("excluded");
      };
    
      let leaderboardInterval; // Variable zum Speichern des Interval-IDs

      window.toggleLeaderboard = function() {
        const container = document.getElementById("leaderboardContentContainer");
        const arrow = document.getElementById("toggleLeaderboard").querySelector(".arrow");
        container.classList.toggle("hidden");
        arrow.classList.toggle("rotated");
      };

      // Globale Variable
      let consensusGenerated = false;

      // Senden der Frage an die aktiven Modelle
      window.sendQuestion = async function() {
        const question = document.getElementById("questionInput").value;
        consensusGenerated = false;
        if (!question) {
          alert("Bitte geben Sie eine Frage ein.");
          return;
        }
        const spinnerHTML = '<span class="spinner"></span>';
        let activeModels = [];
        if (document.getElementById("selectOpenAI").checked) activeModels.push("OpenAI");
        if (document.getElementById("selectMistral").checked) activeModels.push("Mistral");
        if (document.getElementById("selectClaude").checked) activeModels.push("Anthropic Claude");
        if (document.getElementById("selectGemini").checked) activeModels.push("Google Gemini");
        if (document.getElementById("selectDeepSeek").checked) activeModels.push("DeepSeek");
    
        // Spinner in den jeweiligen Response-Boxen setzen
        if (activeModels.includes("OpenAI")) {
          document.getElementById("openaiResponse").querySelector(".collapsible-content").innerHTML = spinnerHTML;
        }
        if (activeModels.includes("Mistral")) {
          document.getElementById("mistalResponse").querySelector(".collapsible-content").innerHTML = spinnerHTML;
        }
        if (activeModels.includes("Anthropic Claude")) {
          document.getElementById("claudeResponse").querySelector(".collapsible-content").innerHTML = spinnerHTML;
        }
        if (activeModels.includes("Google Gemini")) {
          document.getElementById("geminiResponse").querySelector(".collapsible-content").innerHTML = spinnerHTML;
        }
        if (activeModels.includes("DeepSeek")) {
          document.getElementById("deepseekResponse").querySelector(".collapsible-content").innerHTML = spinnerHTML;
        }
        if (document.getElementById("autoConsensusToggle").checked) {
          document.getElementById("consensusResponse").querySelector("p").innerHTML = spinnerHTML;
        } else {
          document.getElementById("consensusResponse").querySelector("p").innerHTML = "";
        }
    
        // API Keys aus localStorage abrufen
        const openaiKey = localStorage.getItem("openaiKey") || "";
        const mistralKey = localStorage.getItem("mistralKey") || "";
        const anthropicKey = localStorage.getItem("anthropicKey") || "";
        const geminiKey = localStorage.getItem("geminiKey") || "";
        const deepseekKey = localStorage.getItem("deepseekKey") || "";
    
        let responsesReceived = 0;
        const totalActive = activeModels.length;
        function checkAllResponses() {
          responsesReceived++;
          if (responsesReceived === totalActive && document.getElementById("autoConsensusToggle").checked) {
            getConsensus();
          }
        }

      // Hilfsfunktion, um einen leeren API Key zu prüfen
      function validateUserKey(keyName) {
        const key = localStorage.getItem(keyName);
        return key && key.trim() !== "";
      }

      // OpenAI
      if (activeModels.includes("OpenAI")) {
        const useOwnKeys = document.getElementById("useOwnKeysSwitch").checked;
        let endpoint = "";
        if (!useOwnKeys) {
          let id_token = localStorage.getItem("id_token");
          if (id_token) {
            endpoint = `/ask_openai?question=${encodeURIComponent(question)}&id_token=${encodeURIComponent(id_token)}`;
          } else {
            const openaiKey = localStorage.getItem("openaiKey") || "";
            endpoint = `/ask_openai?question=${encodeURIComponent(question)}&api_key=${encodeURIComponent(openaiKey)}`;
          }
        } else {
          if (!validateUserKey("openaiKey")) {
            alert("Bitte geben Sie einen gültigen OpenAI API Key ein.");
            // Beende den Request für OpenAI
            return;
          }
          const openaiKey = localStorage.getItem("openaiKey");
          endpoint = `/ask_openai?question=${encodeURIComponent(question)}&api_key=${encodeURIComponent(openaiKey)}`;
        }
        fetch(endpoint)
          .then(response => response.json())
          .then(data => {
            const outputEl = document.getElementById("openaiResponse").querySelector(".collapsible-content");
            if (data.response) {
              outputEl.innerHTML = DOMPurify.sanitize(marked.parse(data.response));
            } else if (data.error) {
              outputEl.innerText = data.error;
            } else {
              outputEl.innerText = "Bitte loggen Sie sich ein oder hinterlegen Sie eigene API Keys.";
            }
            if (data.free_usage_remaining !== undefined) {
              document.getElementById("freeUsageDisplay").innerText =
                "Verbleibende Gratis-Anfragen: " + data.free_usage_remaining + " / " + FREE_USAGE_LIMIT;
            }
            checkAllResponses();
          })
          .catch(error => {
            console.error("Fehler bei OpenAI:", error);
            checkAllResponses();
          });
      }

      // Mistral
      if (activeModels.includes("Mistral")) {
        const useOwnKeys = document.getElementById("useOwnKeysSwitch").checked;
        let endpoint = "";
        if (!useOwnKeys) {
          let id_token = localStorage.getItem("id_token");
          if (id_token) {
            endpoint = `/ask_mistral?question=${encodeURIComponent(question)}&id_token=${encodeURIComponent(id_token)}`;
          } else {
            const mistralKey = localStorage.getItem("mistralKey") || "";
            endpoint = `/ask_mistral?question=${encodeURIComponent(question)}&api_key=${encodeURIComponent(mistralKey)}`;
          }
        } else {
          if (!validateUserKey("mistralKey")) {
            alert("Bitte geben Sie einen gültigen Mistral API Key ein.");
            return;
          }
          const mistralKey = localStorage.getItem("mistralKey");
          endpoint = `/ask_mistral?question=${encodeURIComponent(question)}&api_key=${encodeURIComponent(mistralKey)}`;
        }
        fetch(endpoint)
          .then(response => response.json())
          .then(data => {
            const outputEl = document.getElementById("mistalResponse").querySelector(".collapsible-content");
            if (data.response) {
              outputEl.innerHTML = DOMPurify.sanitize(marked.parse(data.response));
            } else if (data.error) {
              outputEl.innerText = data.error;
            } else {
              outputEl.innerText = "Bitte loggen Sie sich ein oder hinterlegen Sie eigene API Keys.";
            }
            if (data.free_usage_remaining !== undefined) {
              document.getElementById("freeUsageDisplay").innerText =
                "Verbleibende Gratis-Anfragen: " + data.free_usage_remaining + " / " + FREE_USAGE_LIMIT;
            }
            checkAllResponses();
          })
          .catch(error => {
            console.error("Fehler bei Mistral:", error);
            checkAllResponses();
          });
      }

      // Anthropic Claude
      if (activeModels.includes("Anthropic Claude")) {
        const useOwnKeys = document.getElementById("useOwnKeysSwitch").checked;
        let endpoint = "";
        if (!useOwnKeys) {
          let id_token = localStorage.getItem("id_token");
          if (id_token) {
            endpoint = `/ask_claude?question=${encodeURIComponent(question)}&id_token=${encodeURIComponent(id_token)}`;
          } else {
            const anthropicKey = localStorage.getItem("anthropicKey") || "";
            endpoint = `/ask_claude?question=${encodeURIComponent(question)}&api_key=${encodeURIComponent(anthropicKey)}`;
          }
        } else {
          if (!validateUserKey("anthropicKey")) {
            alert("Bitte geben Sie einen gültigen Anthropic API Key ein.");
            return;
          }
          const anthropicKey = localStorage.getItem("anthropicKey");
          endpoint = `/ask_claude?question=${encodeURIComponent(question)}&api_key=${encodeURIComponent(anthropicKey)}`;
        }
        fetch(endpoint)
          .then(response => response.json())
          .then(data => {
            const outputEl = document.getElementById("claudeResponse").querySelector(".collapsible-content");
            if (data.response) {
              outputEl.innerHTML = DOMPurify.sanitize(marked.parse(data.response));
            } else if (data.error) {
              outputEl.innerText = data.error;
            } else {
              outputEl.innerText = "Bitte loggen Sie sich ein oder hinterlegen Sie eigene API Keys.";
            }
            if (data.free_usage_remaining !== undefined) {
              document.getElementById("freeUsageDisplay").innerText =
                "Verbleibende Gratis-Anfragen: " + data.free_usage_remaining + " / " + FREE_USAGE_LIMIT;
            }
            checkAllResponses();
          })
          .catch(error => {
            console.error("Fehler bei Anthropic Claude:", error);
            checkAllResponses();
          });
      }

      // Google Gemini
      if (activeModels.includes("Google Gemini")) {
        const useOwnKeys = document.getElementById("useOwnKeysSwitch").checked;
        let endpoint = "";
        if (!useOwnKeys) {
          let id_token = localStorage.getItem("id_token");
          if (id_token) {
            endpoint = `/ask_gemini?question=${encodeURIComponent(question)}&id_token=${encodeURIComponent(id_token)}`;
          } else {
            const geminiKey = localStorage.getItem("geminiKey") || "";
            endpoint = `/ask_gemini?question=${encodeURIComponent(question)}&api_key=${encodeURIComponent(geminiKey)}`;
          }
        } else {
          if (!validateUserKey("geminiKey")) {
            alert("Bitte geben Sie einen gültigen Google Gemini API Key ein.");
            return;
          }
          const geminiKey = localStorage.getItem("geminiKey");
          endpoint = `/ask_gemini?question=${encodeURIComponent(question)}&api_key=${encodeURIComponent(geminiKey)}`;
        }
        fetch(endpoint)
          .then(response => response.json())
          .then(data => {
            const outputEl = document.getElementById("geminiResponse").querySelector(".collapsible-content");
            if (data.response) {
              outputEl.innerHTML = DOMPurify.sanitize(marked.parse(data.response));
            } else if (data.error) {
              outputEl.innerText = data.error;
            } else {
              outputEl.innerText = "Bitte loggen Sie sich ein oder hinterlegen Sie eigene API Keys.";
            }
            if (data.free_usage_remaining !== undefined) {
              document.getElementById("freeUsageDisplay").innerText =
                "Verbleibende Gratis-Anfragen: " + data.free_usage_remaining + " / " + FREE_USAGE_LIMIT;
            }
            checkAllResponses();
          })
          .catch(error => {
            console.error("Fehler bei Google Gemini:", error);
            checkAllResponses();
          });
      }

      // DeepSeek
      if (activeModels.includes("DeepSeek")) {
        const useOwnKeys = document.getElementById("useOwnKeysSwitch").checked;
        let endpoint = "";
        if (!useOwnKeys) {
          let id_token = localStorage.getItem("id_token");
          if (id_token) {
            endpoint = `/ask_deepseek?question=${encodeURIComponent(question)}&id_token=${encodeURIComponent(id_token)}`;
          } else {
            const deepseekKey = localStorage.getItem("deepseekKey") || "";
            endpoint = `/ask_deepseek?question=${encodeURIComponent(question)}&api_key=${encodeURIComponent(deepseekKey)}`;
          }
        } else {
          if (!validateUserKey("deepseekKey")) {
            alert("Bitte geben Sie einen gültigen DeepSeek API Key ein.");
            return;
          }
          const deepseekKey = localStorage.getItem("deepseekKey");
          endpoint = `/ask_deepseek?question=${encodeURIComponent(question)}&api_key=${encodeURIComponent(deepseekKey)}`;
        }
        fetch(endpoint)
          .then(response => response.json())
          .then(data => {
            const outputEl = document.getElementById("deepseekResponse").querySelector(".collapsible-content");
            if (data.response) {
              outputEl.innerHTML = DOMPurify.sanitize(marked.parse(data.response));
            } else if (data.error) {
              outputEl.innerText = data.error;
            } else {
              outputEl.innerText = "Bitte loggen Sie sich ein oder hinterlegen Sie eigene API Keys.";
            }
            if (data.free_usage_remaining !== undefined) {
              document.getElementById("freeUsageDisplay").innerText =
                "Verbleibende Gratis-Anfragen: " + data.free_usage_remaining + " / " + FREE_USAGE_LIMIT;
            }
            checkAllResponses();
          })
          .catch(error => {
            console.error("Fehler bei DeepSeek:", error);
            checkAllResponses();
          });
      }
      };
    
      // Auswahl der besten Antwort
      window.toggleBest = function(responseId) {
        const box = document.getElementById(responseId);
        if (box.classList.contains("excluded")) return;
        if (box.classList.contains("best")) {
          box.classList.remove("best");
        } else {
          document.querySelectorAll(".response-box").forEach(b => b.classList.remove("best"));
          box.classList.add("best");
        }
      };
    
      // Modelle (Checkboxen) ein-/ausschalten
      window.toggleModel = function(responseId, isChecked) {
        const box = document.getElementById(responseId);
        if (!isChecked) {
          box.classList.add("excluded");
        } else {
          box.classList.remove("excluded");
        }
      };
      document.getElementById("selectOpenAI").addEventListener("change", function() {
        toggleModel("openaiResponse", this.checked);
      });
      document.getElementById("selectMistral").addEventListener("change", function() {
        toggleModel("mistalResponse", this.checked);
      });
      document.getElementById("selectClaude").addEventListener("change", function() {
        toggleModel("claudeResponse", this.checked);
      });
      document.getElementById("selectGemini").addEventListener("change", function() {
        toggleModel("geminiResponse", this.checked);
      });
      document.getElementById("selectDeepSeek").addEventListener("change", function() {
        toggleModel("deepseekResponse", this.checked);
      });
    
      // Erneut API Keys in Felder schreiben (falls benötigt)
      ["openaiKey", "mistralKey", "anthropicKey", "geminiKey", "deepseekKey"].forEach(function(key) {
        const stored = localStorage.getItem(key);
        if (stored) {
          document.getElementById(key).value = stored;
        }
      });
    
      // Globale Variable, um die letzte verarbeitete Frage zu speichern.
      let lastQuestion = "";

      window.getConsensus = async function() {
        const question = document.getElementById("questionInput").value.trim();
          // Status, ob eigene API Keys genutzt werden sollen
        const useOwnKeys = document.getElementById("useOwnKeysSwitch").checked;
        
        // Nur im Gratis-Modus id_token abrufen
        const id_token = useOwnKeys ? null : localStorage.getItem("id_token");

        // Wenn die Frage neu oder geändert ist, werden Firebase-Votes aktualisiert.
        if (question !== lastQuestion) {
          // Für jedes Modell prüfen, ob es als "best" markiert ist.
          if (document.getElementById("openaiResponse").classList.contains("best")) {
            recordModelVote("OpenAI", "best");
          }
          if (document.getElementById("mistalResponse").classList.contains("best")) {
            recordModelVote("Mistral", "best");
          }
          if (document.getElementById("claudeResponse").classList.contains("best")) {
            recordModelVote("Anthropic", "best");
          }
          if (document.getElementById("geminiResponse").classList.contains("best")) {
            recordModelVote("Gemini", "best");
          }
          if (document.getElementById("deepseekResponse").classList.contains("best")) {
            recordModelVote("DeepSeek", "best");
          }

          // Ebenso für "excluded" (sofern du das separat erfassen möchtest).
          if (document.getElementById("openaiResponse").classList.contains("excluded")) {
            recordModelVote("OpenAI", "exclude");
          }
          if (document.getElementById("mistalResponse").classList.contains("excluded")) {
            recordModelVote("Mistral", "exclude");
          }
          if (document.getElementById("claudeResponse").classList.contains("excluded")) {
            recordModelVote("Anthropic", "exclude");
          }
          if (document.getElementById("geminiResponse").classList.contains("excluded")) {
            recordModelVote("Gemini", "exclude");
          }
          if (document.getElementById("deepseekResponse").classList.contains("excluded")) {
            recordModelVote("DeepSeek", "exclude");
          }

          // Aktualisiere die letzte verarbeitete Frage.
          lastQuestion = question;
        }

        // Setze den Konsens-Bereich (Spinner etc.) und rufe anschließend deinen Konsens-Endpunkt auf.
        const consensusDiv = document.getElementById("consensusResponse");
        const mainSpinner = '<span class="spinner"></span>';
        const diffSpinner = '<span class="spinner"></span>';

        consensusDiv.querySelector(".consensus-main p").innerHTML = mainSpinner;
        consensusDiv.querySelector(".consensus-differences p").innerHTML = diffSpinner;

      const consensus_model = document.getElementById("consensusModelDropdown").value;

      // Hole die Antwort-Boxen
      const openaiBox = document.getElementById("openaiResponse");
      const mistalBox = document.getElementById("mistalResponse");
      const claudeBox = document.getElementById("claudeResponse");
      const geminiBox = document.getElementById("geminiResponse");
      const deepseekBox = document.getElementById("deepseekResponse");

      // Lies die Antworten (trim für überflüssige Leerzeichen)
      const answer_openai = openaiBox.querySelector(".collapsible-content").innerText.trim();
      const answer_mistral = mistalBox.querySelector(".collapsible-content").innerText.trim();
      const answer_claude = claudeBox.querySelector(".collapsible-content").innerText.trim();
      const answer_gemini = geminiBox.querySelector(".collapsible-content").innerText.trim();
      const answer_deepseek = deepseekBox.querySelector(".collapsible-content").innerText.trim();

      // Überprüfe nur die Modelle, die nicht als "ausgeschlossen" markiert sind.
      if (
        !question ||
        !consensus_model ||
        (!openaiBox.classList.contains("excluded") && !answer_openai) ||
        (!mistalBox.classList.contains("excluded") && !answer_mistral) ||
        (!claudeBox.classList.contains("excluded") && !answer_claude) ||
        (!geminiBox.classList.contains("excluded") && !answer_gemini) ||
        (!deepseekBox.classList.contains("excluded") && !answer_deepseek)
      ) {
        alert("Bitte zuerst eine Frage senden, alle Antworten abrufen und das Konsens‑Modell auswählen.");
        return;
      }

      // Hole den best markierten Modus (falls vorhanden)
      const bestBox = document.querySelector(".response-box.best");
      let best_model = bestBox ? bestBox.getAttribute("data-model") : "";

      // Die übrigen Parameter wie "excluded_models" werden wie bisher ermittelt
      const excludedModels = [];
      if (openaiBox.classList.contains("excluded")) {
        excludedModels.push(openaiBox.getAttribute("data-model"));
      }
      if (mistalBox.classList.contains("excluded")) {
        excludedModels.push(mistalBox.getAttribute("data-model"));
      }
      if (claudeBox.classList.contains("excluded")) {
        excludedModels.push(claudeBox.getAttribute("data-model"));
      }
      if (geminiBox.classList.contains("excluded")) {
        excludedModels.push(geminiBox.getAttribute("data-model"));
      }
      if (deepseekBox.classList.contains("excluded")) {
        excludedModels.push(deepseekBox.getAttribute("data-model"));
      }

      // Hole API Keys aus localStorage
      const openaiKey = localStorage.getItem("openaiKey") || "";
      const mistralKey = localStorage.getItem("mistralKey") || "";
      const anthropicKey = localStorage.getItem("anthropicKey") || "";
      const geminiKey = localStorage.getItem("geminiKey") || "";
      const deepseekKey= localStorage.getItem("deepseekKey") || "";

      try {
        const response = await fetch("/consensus", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            id_token: id_token,
            useOwnKeys: useOwnKeys,
            question: question,
            answer_openai: answer_openai,
            answer_mistral: answer_mistral,
            answer_claude: answer_claude,
            answer_gemini: answer_gemini,
            answer_deepseek: answer_deepseek,
            best_model: best_model,
            consensus_model: consensus_model,
            excluded_models: excludedModels,
            openai_key: openaiKey,
            mistral_key: mistralKey,
            anthropic_key: anthropicKey,
            gemini_key: geminiKey,
            deepseek_key: deepseekKey
          })
        });
        const data = await response.json();
        if (response.ok) {
          // Aktualisiere den Konsens-Bereich und den Unterschiede-Bereich
          consensusDiv.querySelector(".consensus-main p").innerHTML = marked.parse(data.consensus_response);
          consensusDiv.querySelector(".consensus-differences p").innerHTML = marked.parse(data.differences || "Keine Unterschiede festgestellt.");

          // Parse den BestModel-Wert aus den Unterschieden und aktualisiere das Leaderboard in Firebase
          const bestModelFromConsensus = parseBestModel(data.differences);
          if (bestModelFromConsensus) {
            recordModelVote(bestModelFromConsensus, "BestModel");
          }
        } else {
          consensusDiv.querySelector(".consensus-main p").innerText = "Fehler: " + data.detail;
          consensusDiv.querySelector(".consensus-differences p").innerText = "";
        }
      } catch (error) {
        console.error("Error fetching consensus:", error);
        consensusDiv.querySelector(".consensus-main p").innerText = "Fehler bei der Konsens-Berechnung.";
        consensusDiv.querySelector(".consensus-differences p").innerText = "";
      }
    };
    
      // Testet die API Keys und aktualisiert das Feedback
      window.testAllKeys = async function() {
        const openaiKey = document.getElementById("openaiKey").value;
        const mistralKey = document.getElementById("mistralKey").value;
        const anthropicKey = document.getElementById("anthropicKey").value;
        const geminiKey = document.getElementById("geminiKey").value;
        const deepseekKey = document.getElementById("deepseekKey").value;
        localStorage.setItem("openaiKey", openaiKey);
        localStorage.setItem("mistralKey", mistralKey);
        localStorage.setItem("anthropicKey", anthropicKey);
        localStorage.setItem("geminiKey", geminiKey);
        localStorage.setItem("deepseekKey", deepseekKey);
        const spinner = document.getElementById("apiSpinner");
        spinner.style.display = "inline-block";
        try {
          const response = await fetch("/check_keys", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              openai_key: openaiKey,
              mistral_key: mistralKey,
              anthropic_key: anthropicKey,
              gemini_key: geminiKey,
              deepseek_key: deepseekKey
            })
          });
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText);
          }
          const data = await response.json();
          console.log("Response von /check_keys:", data);
          if (!data || !data.results) {
            throw new Error("Die Antwort enthält kein 'results'-Objekt. Response: " + JSON.stringify(data));
          }
          const openaiResult = data.results["OpenAI"];
          const mistralResult = data.results["Mistral"];
          const anthropicResult = data.results["Anthropic Claude"];
          const geminiResult = data.results["Google Gemini"];
          const deepseekResult = data.results["DeepSeek"];
          const openaiFeedback = document.getElementById("openaiFeedback");
          const mistralFeedback = document.getElementById("mistralFeedback");
          const anthropicFeedback = document.getElementById("anthropicFeedback");
          const geminiFeedback = document.getElementById("geminiFeedback");
          const deepseekFeedback = document.getElementById("deepseekFeedback");
          openaiFeedback.innerHTML = openaiResult === "valid" ? "&#10003;" : "&#10007;";
          openaiFeedback.style.color = openaiResult === "valid" ? "green" : "red";
          mistralFeedback.innerHTML = mistralResult === "valid" ? "&#10003;" : "&#10007;";
          mistralFeedback.style.color = mistralResult === "valid" ? "green" : "red";
          anthropicFeedback.innerHTML = anthropicResult === "valid" ? "&#10003;" : "&#10007;";
          anthropicFeedback.style.color = anthropicResult === "valid" ? "green" : "red";
          geminiFeedback.innerHTML = geminiResult === "valid" ? "&#10003;" : "&#10007;";
          geminiFeedback.style.color = geminiResult === "valid" ? "green" : "red";
          deepseekFeedback.innerHTML = deepseekResult === "valid" ? "&#10003;" : "&#10007;";
          deepseekFeedback.style.color = deepseekResult === "valid" ? "green" : "red";
        } catch (error) {
          console.error("Fehler beim Testen der API Keys:", error);
          alert("Fehler beim Testen der API Keys: " + error.message);
        } finally {
          spinner.style.display = "none";
        }
      };
    
    });
</script>
<!-- Firebase-Code wird jetzt ausgelagert -->
<script type="module" src="/static/firebase.js"></script>
<!-- Login Modal -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeLoginModal">&times;</span>
    <h2>Login</h2>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Passwort">
    <button id="loginButton">Einloggen</button>
    <div id="loginError" class="error-message"></div><br/>
    <!-- Neuer Registrierungs-Button -->
    <button id="registerButton">Registrieren</button>
    <div id="loginError" class="error-message"></div><br/>
    <a href="#" id="forgotPasswordButton">Passwort vergessen?</a>
  </div>
</div>
<!-- recaptcha-Container: Dieser wird für den reCAPTCHA-Verifier benötigt -->
<div id="recaptcha-container"></div>
</body>
</html>
